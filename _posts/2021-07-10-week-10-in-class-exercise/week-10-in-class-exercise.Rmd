---
title: "Week 10 In-Class Exercise"
description: |
  Today I learnt in class: How to use graph analytics to represent relationships and finding connected components. 
author:
  - name: Kelly Koh
    url: https://www.linkedin.com/in/kellykkw/
    affiliation: School of Computing and Information Systems, Singapore Management University
    affiliation_url: https://scis.smu.edu.sg/
date: 07-10-2021
output:
  distill::distill_article:
    toc: true
    toc_depth: 3
    toc_float: true
    self_contained: false
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Install packages and loading data

### Install the necessary packages if they are not in library
```{r echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
packages = c('tidyverse',
             # Handling time variables
             'lubridate','clock',
             # Network graphing
             'network','igraph','tidygraph','ggraph','visNetwork')

for (p in packages) {
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p, character.only = T)
}
```

## Data cleaning

### Import data from csv and preview data
```{r echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
cc_data <- read_csv("data/cc_data.csv")
GAStech_edges <- read_csv("data/GAStech_email_edge-v2.csv")
GAStech_nodes <- read_csv("data/GAStech_email_node.csv")

glimpse(GAStech_edges)
glimpse(GAStech_nodes)
```
SentDate is treated as "Character" data type instead of date type, which needs to be corrected.

### Change the format type of SentDate and add a new Weekday field
```{r echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
GAStech_edges$SentDate = lubridate::dmy(GAStech_edges$SentDate)
GAStech_edges$Weekday = lubridate::wday(GAStech_edges$SentDate,
                             label = TRUE,
                             abbr = FALSE)

glimpse(GAStech_edges)
```


### Summarize the data to find the weight of the relationships
```{r echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
GAStech_edges_aggregated <- GAStech_edges %>%
                            filter(MainSubject == "Work related")  %>%
                            group_by(source, target, Weekday) %>%
                            summarise(Weight = n())  %>%
                            filter(source != target)  %>%
                            filter(Weight > 1)  %>%
                            # Any time we do a group_by, we should do an ungroup
                            ungroup()
glimpse(GAStech_edges_aggregated)
```


### Using tbl_graph to build tidygraph data model
```{r echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
GAStech_graph <- tbl_graph(nodes = GAStech_nodes,
                          edges = GAStech_edges_aggregated,
                          directed = TRUE)
GAStech_graph
```

## Visualizing graph data

### Visualize the data using ggraph which is wrapped over tidygraph
```{r echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
# using the Fruchterman and Reingold layout or "Fr"
g <- ggraph(GAStech_graph,
            layout = "fr") + 
  geom_edge_link(aes(colour = 'grey80')) + 
  geom_node_point(aes(colour = 'grey40', size = 3)) 

g + theme_graph(background = 'grey10',
                text_colour = 'white')
```

### Modifying the node by referring to respective departments
```{r echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
# using the nicely layout 
g <- ggraph(GAStech_graph,
            layout = "nicely") + 
  geom_edge_link(aes()) + 
  geom_node_point(aes(colour = Department, size = 3)) 

g + theme_graph()
```

### Modifying the node by referring to respective departments
```{r echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE, fig.retina=3}
# using the nicely layout 
g <- ggraph(GAStech_graph,
            layout = "nicely") + 
  geom_edge_link(aes(width = Weight), alpha = 0.2) +
  scale_edge_width(range = c(0.1,5)) +
  geom_node_point(aes(colour = Department, size = 3)) 

g + theme_graph()
```

### Working with facet_edges()
```{r echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE, fig.retina=3}
# using the nicely layout 
set_graph_style()
g <- ggraph(GAStech_graph,
            layout = "nicely") + 
  geom_edge_link(aes(width = Weight), alpha = 0.2) +
  scale_edge_width(range = c(0.1,5)) +
  geom_node_point(aes(colour = Department, size = 0.5, alpha = 0.5)) 

g + facet_edges(~Weekday) +
  th_foreground(foreground = "grey80",
                border = TRUE) +
  theme(legend.position = 'bottom')
```

### Working with facet_nodes()
```{r echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE, fig.retina=3}
# using the nicely layout 
set_graph_style()
g <- ggraph(GAStech_graph,
            layout = "nicely") + 
  geom_edge_link(aes(width = Weight), alpha = 0.2) +
  scale_edge_width(range = c(0.1,5)) +
  geom_node_point(aes(colour = Department, size = 0.5, alpha = 0.5))  

g + facet_nodes(~Department) +
  th_foreground(foreground = "grey80",
                border = TRUE) +
  theme(legend.position = 'bottom')
```

### Computing centrality indices
```{r echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE, fig.retina=3}
# using the nicely layout 
set_graph_style()
g <- ggraph(GAStech_graph,
            layout = "nicely") + 
  geom_edge_link(aes(width = Weight), alpha = 0.2) +
  scale_edge_width(range = c(0.1,5)) +
  geom_node_point(aes(colour = Department, size = 0.5, alpha = 0.5))  

g + facet_nodes(~Department) +
  th_foreground(foreground = "grey80",
                border = TRUE) +
  theme(legend.position = 'bottom')
```

### vv
```{r echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
visNetwork(GAStech_nodes,
           GAStech_edges_aggregated, width = "100%")
```

